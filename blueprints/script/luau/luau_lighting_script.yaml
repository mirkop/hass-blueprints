# Luau Themed Lighting Script (Advanced)
# This script cycles each selected RGB light through a unique color from the Luau palette.
# Usage: Call this script with a list of light entities.

alias: Luau Themed Lighting Script
mode: single
description: >
  Advanced script to create a Luau party atmosphere by slowly cycling multiple RGB lights through tropical colors.
  Each light gets a random color from the palette at each step.
fields:
  lights:
    name: RGB Lights
    description: List of RGB light entities to use for the Luau effect.
    required: true
    selector:
      entity:
        domain: light
        multiple: true
  runtime_minutes:
    name: Total Runtime (Minutes)
    description: How many minutes the effect should run for.
    default: 15
    selector:
      number:
        min: 1
        max: 480
        unit_of_measurement: minutes
  cycle_delay:
    name: Color Change Delay
    description: Time (in seconds) between color changes.
    default: 15
    selector:
      number:
        min: 0
        max: 180
        unit_of_measurement: seconds
  light_delay:
    name: Delay Between Lights
    description: Time (in seconds) to wait between changing each light.
    default: 1
    selector:
      number:
        min: 0
        max: 10
        unit_of_measurement: seconds
  transition_time:
    name: Color Transition Time
    description: Time (in seconds) for each color transition.
    default: 5
    selector:
      number:
        min: 0
        max: 30
        unit_of_measurement: seconds
sequence:
  - choose:
      - conditions: "{{ lights | length == 0 }}"
        sequence:
          - stop: "No lights selected. Script will not run."
    default:
      - variables:
          colors:
            - [255, 94, 77]    # Coral
            - [255, 195, 0]    # Yellow
            - [0, 255, 164]    # Aqua
            - [0, 122, 255]    # Blue
            - [255, 0, 191]    # Magenta
            - [255, 102, 255]  # Orchid
            - [0, 255, 255]    # Teal
            - [255, 153, 51]   # Mango Orange
            - [255, 255, 102]  # Pineapple Yellow
            - [102, 255, 178]  # Mint Green
            - [255, 51, 153]   # Hibiscus Pink
            - [204, 255, 51]   # Lime Green
            - [255, 128, 0]    # Sunset Orange
            - [153, 51, 255]   # Orchid Purple
            - [255, 204, 229]  # Plumeria Pink
          num_lights: "{{ lights | length }}"
          repeat_count: >
            {% set total_runtime_seconds = runtime_minutes * 60 %}
            {% set time_per_cycle = cycle_delay + (light_delay * num_lights) %}
            {% set safe_time_per_cycle = time_per_cycle if time_per_cycle > 0 else 1 %}
            {{ (total_runtime_seconds // safe_time_per_cycle) }}
      - repeat:
          count: "{{ repeat_count }}"
          sequence:
            - repeat:
                count: "{{ num_lights }}"
                sequence:
                  - choose:
                      - conditions: "{{ lights[repeat.index] | string != '' }}"
                        sequence:
                          - service: light.turn_on
                            data:
                              entity_id: "{{ lights[repeat.index] | string }}"
                              rgb_color: >
                                {% set current = state_attr(lights[repeat.index], 'rgb_color') %}
                                {% set available = colors | reject('equalto', current) | list %}
                                {{ (available | random) if available else (colors | random) }}
                              brightness: 255
                              transition: "{{ transition_time }}"
                  - delay:
                      seconds: "{{ light_delay }}"
            - delay:
                seconds: "{{ cycle_delay }}"
